# Data Models & Database Schema

This document provides an overview of the primary data models and database tables used in the Zyra application, managed via Supabase (PostgreSQL).

**Note:** The definitive source of truth for the database schema is the collection of SQL migration files located in the `ui/supabase/migrations/` directory. This document provides a descriptive summary.

## Core Tables

### `users`

Stores information about registered users. Linked to Supabase Auth users.

```sql
-- Example columns (actual schema may vary based on Supabase Auth)
id uuid PRIMARY KEY DEFAULT auth.uid(), -- References auth.users
created_at timestamptz DEFAULT now(),
updated_at timestamptz DEFAULT now(),
email text,
-- Other profile information (name, avatar_url, etc.)
-- Potentially billing/subscription status
```

### `workflows`

Stores the definitions of user-created workflows.

```sql
id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
user_id uuid REFERENCES users(id),
name text NOT NULL,
description text,
category text, -- e.g., DeFi, NFT, Automation
tags text[],
definition jsonb NOT NULL, -- The React Flow JSON structure (nodes, edges)
is_public boolean DEFAULT false,
created_at timestamptz DEFAULT now(),
updated_at timestamptz DEFAULT now()
```

### `custom_blocks`

Stores user-defined custom blocks.

```sql
id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
user_id uuid REFERENCES users(id),
name text NOT NULL,
description text,
category text NOT NULL,
inputs jsonb, -- Schema definition for input parameters
outputs jsonb, -- Schema definition for output parameters
config_schema jsonb, -- Schema for configuration fields
code text NOT NULL, -- JavaScript execution logic
is_public boolean DEFAULT false,
created_at timestamptz DEFAULT now(),
updated_at timestamptz DEFAULT now()
```

### `workflow_executions`

Tracks each instance of a workflow being run.

```sql
id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
workflow_id uuid REFERENCES workflows(id),
user_id uuid REFERENCES users(id),
status text NOT NULL DEFAULT 'queued', -- e.g., queued, running, completed, failed, retrying
input_data jsonb, -- Initial data provided to the workflow run
results jsonb, -- Final output or results of the workflow
error_message text, -- Stores error message if execution failed
retry_count integer DEFAULT 0, -- Tracks retry attempts (Added based on memory a1b5e606)
locked_by text, -- Identifier of the worker instance processing this job (Added based on memory a1b5e606)
started_at timestamptz,
completed_at timestamptz,
created_at timestamptz DEFAULT now(),
updated_at timestamptz DEFAULT now()
-- Consider adding indexes on status, user_id, workflow_id, created_at
```

### `node_logs`

Records the execution details and outcome of each individual node within a specific workflow execution.

```sql
id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
execution_id uuid REFERENCES workflow_executions(id) ON DELETE CASCADE,
node_id text NOT NULL, -- The ID of the node within the workflow definition JSON
node_type text, -- The type of the node (e.g., 'custom', 'llm', 'swap')
status text NOT NULL, -- e.g., pending, running, completed, failed
input_data jsonb, -- Data passed into this node
output_data jsonb, -- Data produced by this node
logs text, -- Any specific logs generated by the node's execution
error_message text, -- Error specific to this node's execution
started_at timestamptz,
completed_at timestamptz,
created_at timestamptz DEFAULT now()
-- Consider adding index on execution_id
-- Enforce RLS policy based on workflow_executions.user_id
```

## Planned Tables (Notification System - Memory `53b503e2`)

### `notification_preferences` (Planned)

Stores user preferences for receiving notifications.

```sql
-- Example Structure
id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
user_id uuid REFERENCES users(id) ON DELETE CASCADE,
channel text NOT NULL, -- e.g., 'email', 'telegram', 'discord'
notification_type text NOT NULL, -- e.g., 'workflow_completed', 'workflow_failed', 'node_error'
is_enabled boolean DEFAULT true,
created_at timestamptz DEFAULT now(),
updated_at timestamptz DEFAULT now(),
UNIQUE (user_id, channel, notification_type)
```

### `notification_logs` (Planned)

Records notifications sent to users.

```sql
-- Example Structure
id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
user_id uuid REFERENCES users(id),
workflow_execution_id uuid REFERENCES workflow_executions(id) NULL, -- Optional link to execution
channel text NOT NULL,
notification_type text NOT NULL,
status text NOT NULL, -- e.g., 'sent', 'failed'
error_message text,
sent_at timestamptz DEFAULT now(),
content text -- The actual message content sent
```

### `notification_templates` (Planned)

Stores templates for generating notification messages.

```sql
-- Example Structure
id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
notification_type text NOT NULL UNIQUE, -- e.g., 'workflow_completed'
channel text NOT NULL, -- e.g., 'email', 'discord'
subject_template text, -- For email subjects
body_template text NOT NULL, -- Template string (e.g., using Handlebars, Liquid)
created_at timestamptz DEFAULT now(),
updated_at timestamptz DEFAULT now()
```

## Relationships

-   A `user` can have many `workflows` and `custom_blocks`.
-   A `workflow` can have many `workflow_executions`.
-   A `workflow_execution` typically involves multiple `node_logs` (one per executed node).
-   Notification tables link back to `users` and potentially `workflow_executions`.
